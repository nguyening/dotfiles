# tmux.conf
# for tmux 2.4+
#
# - http://manpages.ubuntu.com/manpages/precise/man1/tmux.1.html

# Set the TMUX_VERSION envvar (up to minor versions)
run-shell "tmux setenv -g TMUX_VERSION $(tmux -V | cut -d' ' -f2)"

# ----------
# General
# ----------

set -g prefix C-a
bind C-a send-prefix -2

# Update SSH socket when re-attaching
set -g update-environment "SSH_AUTH_SOCK SSH_ASKPASS WINDOWID SSH_CONNECTION XAUTHORITY"

# Set window navigation to vi keys
set-window-option -g mode-keys vi

# Do not rename windows automatically
set-option -g allow-rename off

# ----------
# Plugins - prefix + I to install
# ----------

set -g @plugin 'tmux-plugins/tpm'

# sensible - sets up sane defaults and some handy bindings
set -g @plugin 'tmux-plugins/tmux-sensible'

# pain-control - easier pane navigation and creation
set -g @plugin 'tmux-plugins/tmux-pain-control'

# resurrect - save and restore sessions
# continuum - automatically save sessions
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# sessionist - utils for manipulating sessions
set -g @plugin 'tmux-plugins/tmux-sessionist'

# sidebar - adds a directory tree as a toggleable sidebar
set -g @plugin 'tmux-plugins/tmux-sidebar'

# prefix-highlight - adds when prefix is pressed to the status bar
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'

# gitbar - adds git information to the status bar
#set -g @plugin 'aurelien-rainone/tmux-gitbar'

# mta - adds mta subway info to the status bar
#set -g @plugin 'nguyening/tmux-mta'

# ----------
# Plugin settings
# ----------

# tpm
set-environment -g TMUX_PLUGIN_MANAGER_PATH "$HOME/.config/tmux/plugins"

# focus-events
set -g focus-events on

# prefix-highlight
set -g @prefix_highlight_bg 'colour1'                   # set the background (red)
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_output_prefix '#[fg=colour1]#[bg=colour10]#[fg=default]#[bg=colour1] '
set -g @prefix_highlight_output_suffix '#[fg=colour10]#[bg=colour1] #[fg=default]#[bg=default]'
set -g @prefix_highlight_copy_mode_attr 'fg=default,bg=colour1,bold'

# pain-control
set-option -g @pane_resize "2"

# sidebar
set -g @sidebar-tree-command 'tree -C'

# gitbar
# gitbar's .tmux file isn't executable by bash, so we must manually source it
#set-environment -g TMUX_GITBAR_DIR "/home/rnguyen/.config/tmux/plugins/tmux-gitbar"
#source-file "/home/rnguyen/.config/tmux/plugins/tmux-gitbar/tmux-gitbar.tmux"

# mta
set -g @mta_format '#[fg=colour202]#[bg=colour202] {BDFM_fg}● #[fg=default]BDFM #[fg=colour202]#[fg=colour184]#[bg=colour184] {NQR_fg}● #[fg=colour0]NQR #[fg=colour184,bg=default,reverse]#[default]'
#source-file "/home/rnguyen/.config/tmux/plugins/tmux-mta/tmux-mta.tmux"

# ----------
# Display
# ----------

set-option -g base-index 1          # set window to be 1-indexed
set-w -g pane-base-index 1          # set pane to be 1-indexed

# visual notification of activity in other windows
setw -g monitor-activity on
set -g visual-activity off

# ----------
# Status bar
# ----------

set-option -g status on             # enable status bar
set -g status-interval 5            # set update frequency (default: 15 sec)
set -g status-justify centre        # center the window list

# Setting up colors for the status bar. For a listing:
# for i in {0..255}; do
#     printf "\x1b[38;5;${i}mcolour${i}\x1b[0m\n"
#     done

set-option -g status-bg colour10                         # default background (grey)
set-option -g status-fg colour15                         # default text color (white)
set-option -g status-attr default

set-window-option -g window-status-fg colour244
set-window-option -g window-status-bg default
set-window-option -g window-status-attr dim

# active window title colors
set-window-option -g window-status-current-fg colour1   # active window name (red)
set-window-option -g window-status-current-bg default
set-window-option -g window-status-current-attr bright

# pane border
set-option -g pane-border-fg colour10                   # inactive pane border (grey)
set-option -g pane-active-border-fg colour7             # active pane border (white)
set-window-option -g pane-border-status bottom          # position up pane title
set-window-option -g pane-border-format "┤ #{pane_current_command}#T ├"

# message text, for things like activity alerts
set-option -g message-bg default
set-option -g message-fg colour3                        # text color (yellow)

# Set up the left status bar
set -g status-left-length 100                           # set the bar length
set -g status-left '#[bg=colour3,fg=colour16] #H #[fg=colour3,bg=colour4] #[bg=colour4,fg=colour16,noreverse]#S #[bg=default,fg=colour4]'

# Set up the right status bar
set -g status-right-length 100                          # set the right bar length
set -g status-right '#{prefix_highlight}#{@mta_status} #(date +"%a, %b %d %T %Z") #(/home/rnguyen/.config/tmux/plugins/tmux-mta/tmux-mta.tmux)'

# ----------
# Key bindings
# ----------

# organize copy mode
bind Space copy-mode
bind b list-buffers
bind p paste-buffer
bind P choose-buffer
bind o run-shell 'tmux show-buffer | pbcopy'
bind O choose-buffer "run-shell 'tmux show-buffer -b %% | pbcopy'"
bind m run-shell 'tmux show-buffer | pastie | pbcopy'
bind M choose-buffer "run-shell 'tmux show-buffer -b %% | pastie | pbcopy'"


# Match vim-style visual mode behavior

# NOTE: tmux 2.4 has breaking changes to copy-mode key bindings
# https://github.com/tmux/tmux/commit/76d6d3641f271be1756e41494960d96714e7ee58
if-shell -b '[ $(echo "$TMUX_VERSION >= 2.4" | bc) -eq 1 ]' \
    'bind -T copy-mode-vi v send -X begin-selection; \
     bind -T copy-mode-vi C-v send -X rectangle-toggle; \
     bind -T copy-mode-vi y send -X copy-selection-and-cancel; \
     bind -T copy-mode-vi Escape send -X cancel; \
     bind -T copy-mode-vi H send -X start-of-line; \
     bind -T copy-mode-vi L send -X end-of-line' \
    'bind -t vi-copy v begin-selection; \
     bind -t vi-copy C-v rectangle-toggle; \
     bind -t vi-copy y copy-selection; \
     bind -t vi-copy Escape cancel; \
     bind -t vi-copy H start-of-line; \
     bind -t vi-copy L end-of-line'

# This line must be at the very bottom of this file to ensure that TPM
# executes correctly
run '~/.config/tmux/plugins/tpm/tpm'
